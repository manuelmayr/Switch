<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Switch by manuelmayr</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Switch</h1>
        <p>Database Query Language for Ruby</p>
        <p class="view"><a href="https://github.com/manuelmayr/Switch">View the Project on GitHub <small>manuelmayr/Switch</small></a></p>
        <ul>
          <li><a href="https://github.com/manuelmayr/Switch/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/manuelmayr/Switch/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/manuelmayr/Switch">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>Switch - A Query Language for Ruby</h1>

<p><strong>Switch</strong> is a deep embedding of relational Queries into Ruby. With <strong>Switch</strong>
there is no syntactic or stylistic difference between Ruby programs that operate
over in-memory array objects or database-resident tables, even if these programs
rely on array order or nesting. <strong>Switch</strong>'s buil-in compiler and SQL code generator guarantee to emit few queries, addressing long-standing performance problems that trace back to <strong>Rails' ActiveRecord</strong> database binding.</p>

<blockquote>
<p>Looks like Ruby, but performs like handcrafted SQL</p>
</blockquote>

<p>is the ideal that drives the research and development behind <strong>Switch</strong>.</p>

<h2>Installation</h2>

<h3>Setting up Pathfinder</h3>

<p>The relational algebra plans provided by <strong>Switch</strong> are usually too unwiedly to be handled directly by database systems. We rely thus on <a href="http://db.inf.uni-tuebingen.de/research/pathfinder/download">Pathfinder</a> to optimize the plans in
order to get efficient SQL-Code.</p>

<p>On Mac OSX a proper <a href="http://mxcl.github.com/homebrew/">brew</a> formula should be available soon:</p>

<pre><code>brew install pathfinder
</code></pre>

<p>For other platforms download the <strong>Pathfinder</strong> source tarball <a href="http://db.inf.uni-tuebingen.de/files/research/pathfinder/download/pathfinder-0.41.tar.gz">here</a>.</p>

<h3>Download Switch</h3>

<p>Get a clone of <strong>Switch</strong></p>

<pre><code>git clone git@github.com:manuelmayr/Switch.git
</code></pre>

<p>and run <code>rake package</code> in the <strong>Switch</strong> directory.</p>

<p>A simple</p>

<pre><code>gem install ./pkg/switch-0.0.1.gem
</code></pre>

<p>completes the installation and takes care of dependencies.</p>

<h2>Using Switch</h2>

<p>Use the following snippet as IRB initialization file</p>

<pre><code>$ irb -f irb_init.rb
</code></pre>

<p>to play aroung with <strong>Switch</strong>.</p>

<p><strong>Switch</strong> uses <strong>ActiveRecord</strong> merely as an infrastructure to interact with different database systems. <strong>ActiveRecord</strong> is thus <em>not involved</em> in the translation scheme we are using. </p>

<pre><code># filename: irb_init.rb
require "switch"
require "logger"

include Switch
Queryable.engine = Engine.new ActiveRecord::Base

ActiveRecord::Base.logger = Logger.new("/tmp/switch.log")
ActiveRecord::Base.logger.level = Logger::DEBUG
ActiveRecord::Base.logger.datetime_format = "%Y-%m-%d %H:%M:%S"

ActiveRecord::Base.configurations = { 
  'pg' =&gt; {
     :username =&gt; '&lt;username&gt;',
     :password =&gt; '&lt;password&gt;',
     :adapter  =&gt; :postgresql,
     :encoding =&gt; 'utf8',
     :database =&gt; '&lt;database&gt;'
   },  
   'db2' =&gt; {
     :username =&gt; '&lt;username&gt;',
     :password =&gt; '&lt;password&gt;',
     :adapter  =&gt; :ibm_db,
     :encoding =&gt; 'utf8',
     :database =&gt; '&lt;database&gt;'
   },  
}


ActiveRecord::Base.establish_connection 'db2'  # for DB2 or pg for postgres
</code></pre>

<p>The queries generated by <strong>Switch</strong> are dumped to <code>/tmp/switch.log</code>.</p>

<h2>Examples</h2>

<p>The <code>to_sql</code> trigger method is used to display the associated SQL-Code of a Query. Use the <code>each</code> trigger method to execute a query on a database and marshal the 
result back to <strong>Ruby</strong> objects.</p>

<p><strong>Executing a query on a database:</strong></p>

<pre><code># Articles is a table in a database automatically recognized by Switch as such
Articles.select { |id, name, price| price &gt;= 42 }.each do |a|
  puts "#{a[:name]} =&gt; #{a[:price]}"
end
</code></pre>

<h3>Literals</h3>

<p>The rather tedious constructor <code>Atom</code> is only used when we use a literal
as source object to a query.<br><strong>Switch</strong> is able to cope with</p>

<ol>
<li>numeric literals</li>
<li>strings</li>
<li>arbitrary nested lists</li>
<li>records</li>
</ol><p><strong>Numeric Literals and Strings</strong></p>

<pre><code>Atom(42).to_sql
Atom(3.14).to_sql
Atom("Hello World!").to_sql
</code></pre>

<p><strong>Arbitrary Nested Lists</strong></p>

<pre><code>Atom([1,2,3]).to_sql
Atom([ [1,2], [3,4] ]).to_sql 
Atom([ [1,2], 3 ]).to_sql     # Attention: This is not possible

# more complicated stuff
Atom([[1,2,3],[4,5,6]]).flatten.take(4).drop(3).to_sql # =&gt; [4]
Atom([[[1,2,3],[4,5,6]]]).nth(1).nth(2).take(2).drop(1).to_sql # =&gt; [5] 
</code></pre>

<p><strong>Records</strong></p>

<pre><code>Atom({ a:10, b:42 }).to_sql
Atom({ a:{ b:10, c:42 }, d:[12,67], e:"34" }).to_sql
</code></pre>

<h3>Table Access</h3>

<p>Tables in a database are automatically recognized by <strong>Switch</strong>. Supposed
you have a table <code>Articles</code> in your database, accessing it via <strong>Switch</strong>
is really smooth.</p>

<pre><code>Articles.to_sql
</code></pre>

<p><strong>Switch</strong> checks if there is really an <code>Articles</code> table in your database and
provides a queryable object. Each table is simply a list of record. In case
of <code>Articles</code> it would e.g. be the following (<code>[{ id:1, name:"IPhone 4S", price:629.00 }, { id:2, name:"Macbook Air 13", price:1249.00}, ...]</code>)</p>

<pre><code># getting the name of each article
Articles.map { |a| a.name }.take(5).to_sql
# or
Articles.map { |id,name,price| name }.take(5).sql

# adding 42 to the price of each product
# that is cheaper than 23 bucks
Articles.select { |a| a.price &lt; 23 }.
         map { |a| 
                   { id:a.id,
                     name:a.name,
                     price:a.price + 42 } }.
         to_sql
</code></pre>

<h3>Use Ruby Syntax</h3>

<pre><code>Atom([[1,2,3],[3]]).map(&amp;:length).to_sql # =&gt; [3,1]

</code></pre>

<h3>Query Combinators aka Methods</h3>

<p>The examples above are just a small subset of what you can accomplish with <strong>Switch</strong>. <strong>Switch</strong> supports the following methods you can use in your queries:</p>

<pre><code>map select group_by sort_by partition uniq flatten flat_map zip all? any?
none? empty? one? member? append reverse take drop take_while drop_while
at first last length avg sum max min max_by min_by
</code></pre>

<h2>Additional</h2>

<p>The <code>to_sql</code> method accepts a file or a string to write to<br><code>to_sql("foo.sql")</code> or <code>to_sql(File.open("foo.sql", "w"))</code>.<br>
Usually it writes to STDOUT.</p>

<h2>References</h2>

<ul>
<li>
<a href="http://db.inf.uni-tuebingen.de/publications/">A Deep Embedding of Queries into Ruby</a><br>
Torsten Grust, Manuel Mayr.<br>
In Proceedings of the 28th IEEE International Conference on Data Engineering (ICDE 2012), Washington, DC, USA, April 2012.</li>
</ul>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/manuelmayr">manuelmayr</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>